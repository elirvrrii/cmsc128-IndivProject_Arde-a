<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <title>WHAT TO-DO</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    <link rel="stylesheet" href="to-do-design.css">
</head>
<body>
<div class="container my-4">
    <div class="d-flex justify-content-between align-items-start mb-4">
        <div>
            <h1 class="mb-2">WHAT TO-DO.</h1>
            <p class="text-muted mb-0 fs-5">Welcome, <span id="userName">User</span>!</p>
        </div>
        <div class="d-flex gap-2 align-items-center">
            <a href="profile.html" class="btn btn-outline-secondary">Profile</a>
            <button id="logoutBtn" class="btn btn-outline-danger">Logout</button>
        </div>
    </div>

    <div class="mb-4 d-flex gap-2">
        <button id="personalModeBtn" class="mode-btn active">Personal</button>
        <button id="collabModeBtn" class="mode-btn">Collaborative</button>
    </div>

    <div id="collab-list-section" style="display:none;">
        <h5 class="mb-3 fw-bold">Collaborative Lists</h5>
        <div id="collab-list-options" class="d-flex flex-column gap-2 mb-3"></div>
        <div class="card p-3 mb-4" style="background: linear-gradient(135deg, #f5f7fa 0%, #e8ecf3 100%);">
            <h6 class="mb-2 fw-semibold">Create New List</h6>
            <div class="d-flex gap-2">
                <input id="newCollabName" class="form-control" placeholder="Enter list name">
                <button id="createCollabBtn" class="btn btn-primary">Create</button>
            </div>
        </div>
    </div>

    <form id="task-form" class="card shadow-sm p-3 mb-4">
        <input type="text" id="taskName" class="form-control form-control-lg mb-3" placeholder="Enter your task..." required>
        <div class="row g-2">
            <div class="col-md-3"><input type="date" id="taskDueDate" class="form-control" required></div>
            <div class="col-md-3"><input type="time" id="taskDueTime" class="form-control" required></div>
            <div class="col-md-3">
                <select id="taskPriority" class="form-select" required>
                    <option value="low">游릭 Low</option>
                    <option value="medium">游리 Medium</option>
                    <option value="high">游댮 High</option>
                </select>
            </div>
            <div class="col-md-3 d-grid">
                <button type="submit" class="btn btn-primary">ADD</button>
            </div>
        </div>
    </form>

    <div id="sort" class="d-flex justify-content-end gap-2 mb-3">
        Sort by:
        <button id="sortDateAdded" class="btn btn-sm">Date Added</button>
        <button id="sortDueDate" class="btn btn-sm">Due Date</button>
        <button id="sortPriority" class="btn btn-sm">Priority</button>
    </div>

    <div id="indv-tasks" class="d-flex flex-column gap-2"></div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p id="deleteMessage">Are you sure you want to delete this?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Collaborative List Modal -->
<div class="modal fade" id="editCollabModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Collaborative List</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <h6 class="mb-2">Members</h6>
                <div id="memberList" class="d-flex flex-column gap-2 mb-3"></div>
                <hr>
                <h6 class="mb-2">Add Member</h6>
                <div class="d-flex gap-2">
                    <input id="modalAddEmail" class="form-control" placeholder="Enter member email">
                    <button id="modalAddBtn" class="btn btn-primary">Add</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
import { getDatabase, ref, push, set, update, remove, onValue, get } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-database.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";

const firebaseConfig = { 
    apiKey: "AIzaSyCfxNU7BbmtvNlTBdEFa4JEq8MbnT5r41Q",
    authDomain: "what-to-do-2fcc7.firebaseapp.com",
    databaseURL: "https://what-to-do-2fcc7-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "what-to-do-2fcc7",
    storageBucket: "what-to-do-2fcc7.appspot.com",
    messagingSenderId: "982422793450",
    appId: "1:982422793450:web:9339738576ddf5837ebb93"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth();
const db = getDatabase();

let tasksArray = [];
let currentMode = 'personal';
let currentListId = null;
let currentUnsubscribe = null;
let deleteCallback = null;

const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
const editModal = new bootstrap.Modal(document.getElementById('editCollabModal'));

// Format date to DD/MM/YYYY
function formatDate(dateStr) {
    const [year, month, day] = dateStr.split('-');
    return `${day}/${month}/${year}`;
}

// Format time to 12-hour format
function formatTime(timeStr) {
    const [hours, minutes] = timeStr.split(':');
    const hour = parseInt(hours);
    const ampm = hour >= 12 ? 'PM' : 'AM';
    const hour12 = hour % 12 || 12;
    return `${hour12}:${minutes} ${ampm}`;
}

// Format date added timestamp
function formatDateAdded(timestamp) {
    const date = new Date(timestamp);
    const day = String(date.getDate()).padStart(2, '0');
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const year = date.getFullYear();
    return `${day}/${month}/${year}`;
}

onAuthStateChanged(auth, async user => {
    if (!user) {
        window.location.href = "index.html";
    } else {
        const userRef = ref(db, "users/" + user.uid);
        const snapshot = await get(userRef);
        if (snapshot.exists()) {
            const userData = snapshot.val();
            document.getElementById('userName').textContent = userData.name || 'User';
        }
        loadPersonalTasks(user.uid);
    }
});

function switchMode(mode) {
    currentMode = mode;
    if (mode === 'personal') {
        document.getElementById('personalModeBtn').classList.add('active');
        document.getElementById('collabModeBtn').classList.remove('active');
        document.getElementById('collab-list-section').style.display = 'none';
        currentListId = null;
        loadPersonalTasks(auth.currentUser.uid);
    } else {
        document.getElementById('collabModeBtn').classList.add('active');
        document.getElementById('personalModeBtn').classList.remove('active');
        document.getElementById('collab-list-section').style.display = 'block';
        document.getElementById('indv-tasks').innerHTML = '<p class="text-muted">Select a collaborative list to view tasks</p>';
        loadUserCollaborativeLists();
    }
}

document.getElementById('personalModeBtn').addEventListener('click', () => switchMode('personal'));
document.getElementById('collabModeBtn').addEventListener('click', () => switchMode('collab'));
document.getElementById("logoutBtn").addEventListener("click", () => signOut(auth).then(() => location.href="index.html"));

document.getElementById('createCollabBtn').addEventListener('click', async () => {
    const name = document.getElementById('newCollabName').value.trim();
    if (!name) return alert('Enter a list name');
    const user = auth.currentUser;
    const listRef = push(ref(db, 'collabLists')); 
    await set(listRef, { name, owner: user.uid, members: { [user.uid]: true } });
    await set(ref(db, `collabTasks/${listRef.key}`), {});
    document.getElementById('newCollabName').value = '';
    loadUserCollaborativeLists();
});

function addData() {
    const user = auth.currentUser;
    const payload = { 
        name: document.getElementById('taskName').value, 
        dueDate: document.getElementById('taskDueDate').value, 
        dueTime: document.getElementById('taskDueTime').value, 
        priority: document.getElementById('taskPriority').value, 
        isDone: false, 
        addedOn: Date.now() 
    };
    if (currentMode === 'personal') {
        set(push(ref(db, "tasks/" + user.uid)), payload);
    } else if (currentListId) {
        set(push(ref(db, `collabTasks/${currentListId}`)), payload);
    }
    document.getElementById('task-form').reset();
}

function loadPersonalTasks(uid) {
    if (currentUnsubscribe) currentUnsubscribe();
    currentUnsubscribe = onValue(ref(db, "tasks/" + uid), snapshot => {
        tasksArray = [];
        snapshot.forEach(child => tasksArray.push({...child.val(), id: child.key}));
        renderTasks();
    });
}

function loadUserCollaborativeLists() {
    if (currentUnsubscribe) currentUnsubscribe();
    currentUnsubscribe = onValue(ref(db, 'collabLists'), snapshot => {
        document.getElementById('collab-list-options').innerHTML = '';
        const uid = auth.currentUser.uid;
        snapshot.forEach(child => {
            const list = child.val(); 
            const listId = child.key;
            if (list.members?.[uid]) {
                const div = document.createElement('div');
                div.className = 'collab-list-card';
                div.innerHTML = `
                    <span class="collab-list-name">${list.name}</span>
                    <div class="collab-list-actions">
                        <button class="icon-btn edit" title="Edit">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="icon-btn delete" title="Delete">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                `;
                
                div.addEventListener('click', (e) => {
                    if (!e.target.closest('.collab-list-actions')) {
                        currentListId = listId; 
                        loadCollaborativeTasks(listId);
                        document.querySelectorAll('.collab-list-card').forEach(card => card.classList.remove('active-list'));
                        div.classList.add('active-list');
                    }
                });
                
                div.querySelector('.edit').onclick = (e) => {
                    e.stopPropagation();
                    openEditModal(listId, list);
                };
                
                div.querySelector('.delete').onclick = (e) => {
                    e.stopPropagation();
                    document.getElementById('deleteMessage').textContent = `Are you sure you want to delete "${list.name}"?`;
                    deleteCallback = () => {
                        remove(ref(db, `collabLists/${listId}`));
                        remove(ref(db, `collabTasks/${listId}`));
                        deleteModal.hide();
                    };
                    deleteModal.show();
                };

                document.getElementById('collab-list-options').appendChild(div);
            }
        });
        if (!document.getElementById('collab-list-options').hasChildNodes()) {
            document.getElementById('collab-list-options').innerHTML = '<p class="text-muted">You are not a member of any collaborative list.</p>';
        }
    });
}

function loadCollaborativeTasks(listId) {
    if (currentUnsubscribe) currentUnsubscribe();
    currentUnsubscribe = onValue(ref(db, `collabTasks/${listId}`), snapshot => {
        tasksArray = [];
        snapshot.forEach(child => tasksArray.push({...child.val(), id: child.key}));
        renderTasks();
    });
}

async function addUserToListByEmail(listId, email) { 
    const usersSnap = await get(ref(db, 'users'));
    let foundUid = null;
    usersSnap.forEach(child => { 
        if (child.val()?.email?.toLowerCase() === email.toLowerCase()) {
            foundUid = child.key;
        }
    });
    if (!foundUid) return alert('User not found.');
    await update(ref(db, `collabLists/${listId}/members`), { [foundUid]: true }); 
    loadUserCollaborativeLists();
}

function deleteTask(task, taskDiv) {
    const user = auth.currentUser;
    document.getElementById('deleteMessage').textContent = `Are you sure you want to delete "${task.name}"?`;
    deleteCallback = () => {
        const refPath = currentMode === 'personal' ? `tasks/${user.uid}/${task.id}` : `collabTasks/${currentListId}/${task.id}`;
        remove(ref(db, refPath)).then(() => { 
            taskDiv.remove(); 
            showUndoToast("Task deleted", () => set(ref(db, refPath), task)); 
        });
        deleteModal.hide();
    };
    deleteModal.show();
}

document.getElementById('confirmDeleteBtn').addEventListener('click', () => {
    if (deleteCallback) deleteCallback();
});

function showUndoToast(message, undoCallback) {
    const undoToast = document.createElement('div'); 
    undoToast.className = "undoToast";
    undoToast.innerHTML = `<div>${message}</div><button id="undo-btn">Undo</button><button id="close-btn">&times;</button>`;
    document.body.appendChild(undoToast);
    undoToast.querySelector('#undo-btn').onclick = () => { 
        undoCallback(); 
        undoToast.remove(); 
        renderTasks(); 
    };
    undoToast.querySelector('#close-btn').onclick = () => undoToast.remove();
    setTimeout(() => undoToast.remove(), 5000);
}

function editTask(task, taskDiv) {
    const infoDiv = taskDiv.querySelector('.task-info');
    const actionsDiv = taskDiv.querySelector('.task-actions');
    infoDiv.innerHTML = `
        <input type="text" class="form-control mb-1" value="${task.name}">
        <input type="date" class="form-control mb-1" value="${task.dueDate}">
        <input type="time" class="form-control mb-1" value="${task.dueTime}">
        <select class="form-select mb-1">
            <option value="low" ${task.priority === 'low' ? 'selected' : ''}>游릭 Low</option>
            <option value="medium" ${task.priority === 'medium' ? 'selected' : ''}>游리 Medium</option>
            <option value="high" ${task.priority === 'high' ? 'selected' : ''}>游댮 High</option>
        </select>
    `;
    actionsDiv.innerHTML = `
        <button class="save-btn btn btn-sm btn-success me-2">Save</button>
        <button class="cancel-btn btn btn-sm btn-secondary">Cancel</button>
    `;
    actionsDiv.querySelector('.save-btn').onclick = () => {
        const updated = {
            name: infoDiv.querySelector('input[type=text]').value,
            dueDate: infoDiv.querySelector('input[type=date]').value,
            dueTime: infoDiv.querySelector('input[type=time]').value,
            priority: infoDiv.querySelector('select').value
        };
        const refPath = currentMode === 'personal' ? `tasks/${auth.currentUser.uid}/${task.id}` : `collabTasks/${currentListId}/${task.id}`;
        update(ref(db, refPath), updated); 
        renderTasks();
    };
    actionsDiv.querySelector('.cancel-btn').onclick = () => renderTasks();
}

function renderTasks() {
    document.getElementById('indv-tasks').innerHTML = '';
    tasksArray.forEach(task => {
        const taskDiv = document.createElement('div'); 
        taskDiv.className = `card p-3 mb-2 priority-${task.priority}`;
        const escapedName = document.createElement('div').appendChild(document.createTextNode(task.name)).parentNode.innerHTML;
        taskDiv.innerHTML = `
            <div class="d-flex justify-content-between align-items-start">
                <div class="task-info d-flex align-items-start flex-grow-1">
                    <input type="checkbox" class="markasDone me-2 mt-1" ${task.isDone ? 'checked' : ''}>
                    <div class="flex-grow-1">
                        <h5 class="mb-1${task.isDone ? ' completed' : ''}">${escapedName}</h5>
                        <p class="mb-0${task.isDone ? ' completed' : ''}">Due: ${formatDate(task.dueDate)} ${formatTime(task.dueTime)}</p>
                    </div>
                </div>
                <div class="task-actions d-flex gap-2">
                    <button class="icon-btn edit" title="Edit">
                        <i class="bi bi-pencil"></i>
                    </button>
                    <button class="icon-btn delete" title="Delete">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            </div>
            <div class="task-card-footer">
                <div class="date-added">Added: ${formatDateAdded(task.addedOn)}</div>
            </div>
        `;
        
        taskDiv.querySelector('.markasDone').onchange = e => {
            update(ref(db, `${currentMode === 'personal' ? 'tasks/' + auth.currentUser.uid : 'collabTasks/' + currentListId}/${task.id}`), {isDone: e.target.checked});
            taskDiv.querySelector('h5').classList.toggle('completed', e.target.checked);
            taskDiv.querySelector('p').classList.toggle('completed', e.target.checked);
        };
        taskDiv.querySelector('.edit').onclick = () => editTask(task, taskDiv);
        taskDiv.querySelector('.delete').onclick = () => deleteTask(task, taskDiv);
        document.getElementById('indv-tasks').appendChild(taskDiv);
    });
}

document.getElementById('task-form').onsubmit = e => {
    e.preventDefault(); 
    addData();
};

document.getElementById('sortDateAdded').onclick = () => { 
    tasksArray.sort((a, b) => a.addedOn - b.addedOn); 
    renderTasks(); 
};
document.getElementById('sortDueDate').onclick = () => { 
    tasksArray.sort((a, b) => new Date(a.dueDate + ' ' + a.dueTime) - new Date(b.dueDate + ' ' + b.dueTime)); 
    renderTasks(); 
};
document.getElementById('sortPriority').onclick = () => { 
    const map = {low: 3, medium: 2, high: 1}; 
    tasksArray.sort((a, b) => map[a.priority] - map[b.priority]); 
    renderTasks(); 
};

async function openEditModal(listId, listData) {
    const memberList = document.getElementById('memberList'); 
    memberList.innerHTML = '';
    const usersSnap = await get(ref(db, 'users'));
    
    for (const uid in listData.members) {
        let email = '(unknown)';
        let name = '(unknown)';
        usersSnap.forEach(child => {
            if (child.key === uid) {
                email = child.val().email;
                name = child.val().name || '(No name)';
            }
        });
        
        const div = document.createElement('div'); 
        div.className = "member-card";
        div.innerHTML = `
            <div class="member-info">
                <div class="member-name">${name}</div>
                <div class="member-email">${email}</div>
            </div>
            <button class="btn btn-sm btn-danger remove-member">Remove</button>
        `;
        div.querySelector(".remove-member").onclick = () => {
            document.getElementById('deleteMessage').textContent = `Remove ${name} (${email}) from this list?`;
            deleteCallback = () => {
                remove(ref(db, `collabLists/${listId}/members/${uid}`));
                div.remove();
                deleteModal.hide();
            };
            deleteModal.show();
        };
        memberList.appendChild(div);
    }
    
    document.getElementById("modalAddBtn").onclick = async () => {
        const email = document.getElementById("modalAddEmail").value.trim(); 
        if (!email) return alert("Enter email");
        await addUserToListByEmail(listId, email);
        openEditModal(listId, (await get(ref(db, `collabLists/${listId}`))).val());
    };
    editModal.show();
}
</script>
</body>
</html>